<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/css/xterm.min.css" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { width: 100%; height: 100%; overflow: hidden; background: #1e1e1e; }
    #terminal { width: 100%; height: 100%; }
    .xterm { height: 100%; }
  </style>
</head>
<body>
  <div id="terminal"></div>
  <script src="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/lib/xterm.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@xterm/addon-fit@0.10.0/lib/addon-fit.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@xterm/addon-web-links@0.11.0/lib/addon-web-links.min.js"></script>
  <script>
    const term = new Terminal({
      cursorBlink: true,
      fontSize: 14,
      fontFamily: "'Fira Code', 'Cascadia Code', 'JetBrains Mono', 'Courier New', monospace",
      theme: {
        background: '#1e1e1e',
        foreground: '#d4d4d4',
        cursor: '#d4d4d4',
        selectionBackground: '#264f78',
        black: '#1e1e1e',
        red: '#f44747',
        green: '#6a9955',
        yellow: '#d7ba7d',
        blue: '#569cd6',
        magenta: '#c586c0',
        cyan: '#4ec9b0',
        white: '#d4d4d4',
        brightBlack: '#808080',
        brightRed: '#f44747',
        brightGreen: '#6a9955',
        brightYellow: '#d7ba7d',
        brightBlue: '#569cd6',
        brightMagenta: '#c586c0',
        brightCyan: '#4ec9b0',
        brightWhite: '#ffffff',
      },
      allowProposedApi: true,
    });

    const fitAddon = new FitAddon.FitAddon();
    const webLinksAddon = new WebLinksAddon.WebLinksAddon();

    term.loadAddon(fitAddon);
    term.loadAddon(webLinksAddon);
    term.open(document.getElementById('terminal'));

    // Fit to container
    fitAddon.fit();

    // Send initial dimensions to React Native
    function sendDimensions() {
      window.ReactNativeWebView.postMessage(JSON.stringify({
        type: 'resize',
        cols: term.cols,
        rows: term.rows,
      }));
    }

    // Relay keystrokes to React Native
    term.onData((data) => {
      window.ReactNativeWebView.postMessage(JSON.stringify({
        type: 'input',
        data: data,
      }));
    });

    // Handle resize
    const resizeObserver = new ResizeObserver(() => {
      fitAddon.fit();
      sendDimensions();
    });
    resizeObserver.observe(document.getElementById('terminal'));

    // Send initial size after a brief delay to ensure layout is settled
    setTimeout(() => {
      fitAddon.fit();
      sendDimensions();
    }, 100);

    // Listen for messages from React Native
    // We use document event listener as WebView injects messages this way
    window.addEventListener('message', (event) => {
      handleMessage(event.data);
    });
    // Android uses document.addEventListener
    document.addEventListener('message', (event) => {
      handleMessage(event.data);
    });

    function handleMessage(raw) {
      try {
        const msg = JSON.parse(raw);
        switch (msg.type) {
          case 'output':
            term.write(msg.data);
            break;
          case 'focus':
            term.focus();
            break;
          case 'blur':
            term.blur();
            break;
        }
      } catch (e) {
        console.error('Failed to parse message from RN:', e);
      }
    }
  </script>
</body>
</html>
